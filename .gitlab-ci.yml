image: python:3.10-slim

stages:
  - build
  - test
  - deploy

before_script:
  - apt-get update -y
  # libgomp1 is not included in small Docker images, but needed for numpy
  - apt-get install -y libgomp1 --no-install-recommends
  # Disable warnings about newer pip versions available
  - pip config set global.disable-pip-version-check true
  - pip install -e .

pypi:
  stage: build
  script:
  - python3 setup.py sdist
  artifacts:
    expire_in: 1 week
  only:
    changes:
      - eminus/version.py

flake8:
  stage: test
  script:
  - pip install flake8
  - flake8 eminus/ examples/ tests/
  artifacts:
    expire_in: 1 week
  only:
    changes:
      - eminus/*
      - eminus/**/*
      - examples/*
      - tests/*

pytest:
  stage: test
  script:
  - pip install pytest
  - pytest --tb=short tests/
  artifacts:
    expire_in: 1 week
  only:
    changes:
      - eminus/*
      - eminus/**/*

pages:
  stage: deploy
  script:
    - pip install sphinx furo
    - sphinx-build -b html ./docs ./public
  artifacts:
    paths:
    - public
    expire_in: 1 week
  only:
    changes:
      - docs/*
      - docs/**/*
      - eminus/version.py
