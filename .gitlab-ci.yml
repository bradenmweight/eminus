image: python:3.10-slim

stages:
  - test
  - deploy

before_script:
  - apt-get update -y
  # libgomp1 is not included in slim python images but needed for numpy
  - apt-get install -y libgomp1 --no-install-recommends
  # Disable warnings about running pip as root user
  - pip config set global.root-user-action ignore
  - pip install -e .

# Lint check python files
flake8:
  stage: test
  script:
    - pip install flake8 flake8-docstrings flake8-import-order
    - flake8
  only:
    changes:
      - ./*.py
      - ./**/*.py

# Test code functionality for the oldest and newest supported python version
.pytest:
  stage: test
  script:
    - pip install pytest
    - pytest tests/dft_calculations --tb=short
  only:
    changes:
      - eminus/*.py
      - eminus/**/*.py
      - tests/*.py
      - tests/**/*.py
pytest-newest:
  extends: .pytest
pytest-oldest:
  image: python:3.6-slim
  extends: .pytest

# Build documentation
pages:
  stage: deploy
  script:
    # Build sphinx documentation
    - pip install sphinx furo
    - sphinx-build -b html ./docs ./public
    # Convert notebooks to html
    - pip install notebook
    - find examples -name '*.ipynb' -exec jupyter nbconvert --to html {} --template classic \;
    - find examples -name '*.html' -exec mv {} public/_static \;
    # Minify all text files
    - apt-get install -y minify
    - find public \( -name '*.css' -o -name '*.js' -o -name '*.svg' \) -exec minify -vo {} {} \;
    - find public -name '*.html' -exec minify -vo {} {} --html-keep-document-tags --html-keep-end-tags \;
    # Compress all text files
    - find public \( -name '*.css' -o -name '*.html' -o -name '*.js' -o -name '*.svg' \) -exec gzip -vrk9 {} \;
  artifacts:
    paths:
      - public
  only:
    changes:
      - docs/*
      - docs/**/*
    refs:
      - main
